name: Auto-resolve SF metadata conflicts

on:
  push:
    branches: [main]
    paths:
      - 'force-app/**/*-meta.xml'
      - 'package.xml'
      - 'destructiveChanges*.xml'

  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to resolve (leave empty to scan all open PRs)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: read

jobs:
  resolve-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Salesforce CLI and merge driver plugin
        run: |
          npm install -g @salesforce/cli
          echo "y" | sf plugins install sf-git-merge-driver
          sf git merge driver install

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find and resolve conflicting PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ -n "${{ inputs.pr_number || '' }}" ]; then
            PR_NUMBERS="${{ inputs.pr_number }}"
          else
            PR_NUMBERS=$(gh pr list --state open --json number --jq '.[].number')
          fi

          if [ -z "$PR_NUMBERS" ]; then
            echo "No open PRs found."
            exit 0
          fi

          RESOLVED=0
          FAILED=0
          SKIPPED=0

          for PR in $PR_NUMBERS; do
            echo "========================================="
            echo "Processing PR #$PR"
            echo "========================================="

            PR_DATA=$(gh pr view "$PR" --json headRefName,mergeable,mergeStateStatus)
            BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
            MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')

            echo "Branch: $BRANCH"
            echo "Mergeable: $MERGEABLE"

            # If UNKNOWN, wait for GitHub to compute
            if [ "$MERGEABLE" = "UNKNOWN" ]; then
              echo "Waiting for GitHub to compute mergeability..."
              for i in 1 2 3 4 5 6; do
                sleep 5
                PR_DATA=$(gh pr view "$PR" --json headRefName,mergeable)
                MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')
                echo "  Attempt $i: $MERGEABLE"
                if [ "$MERGEABLE" != "UNKNOWN" ]; then break; fi
              done
            fi

            if [ "$MERGEABLE" = "MERGEABLE" ]; then
              echo "PR #$PR is already mergeable, skipping."
              SKIPPED=$((SKIPPED + 1))
              continue
            fi

            echo "PR #$PR has conflicts. Attempting auto-resolve with sf-git-merge-driver..."

            git fetch origin "$BRANCH" 2>/dev/null || {
              echo "Failed to fetch branch $BRANCH, skipping."
              FAILED=$((FAILED + 1))
              continue
            }

            git checkout "origin/$BRANCH" 2>/dev/null

            if git merge origin/main --no-edit; then
              echo "Merge succeeded cleanly!"
              git push origin HEAD:"$BRANCH" && {
                echo "PR #$PR resolved and pushed."
                RESOLVED=$((RESOLVED + 1))
              } || {
                echo "Failed to push resolved branch for PR #$PR."
                FAILED=$((FAILED + 1))
              }
            else
              echo "PR #$PR has real semantic conflicts that need manual resolution."
              git merge --abort 2>/dev/null || true
              FAILED=$((FAILED + 1))
            fi

            git checkout main 2>/dev/null
          done

          echo ""
          echo "========================================="
          echo "Summary: $RESOLVED resolved, $SKIPPED already clean, $FAILED need manual fix"
          echo "========================================="
